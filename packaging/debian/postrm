#!/bin/bash
set -e

case "$1" in
    purge)
        # Remove system user and group
        if id dmx-bridge >/dev/null 2>&1; then
            userdel dmx-bridge || true
        fi
        if getent group dmx-bridge >/dev/null 2>&1; then
            groupdel dmx-bridge || true
        fi

        # Remove data directory and all contents
        if [ -d /var/lib/dmx-bridge ]; then
            echo "Removing data directory /var/lib/dmx-bridge..."
            rm -rf /var/lib/dmx-bridge || true
        fi

        # Note: /etc/dmx-bridge/config.toml is automatically removed by dpkg
        # as a conffile, but we should clean up the directory if empty
        if [ -d /etc/dmx-bridge ]; then
            rmdir --ignore-fail-on-non-empty /etc/dmx-bridge || true
        fi

        # Remove application directory
        if [ -d /opt/dmx-lan-bridge ]; then
            echo "Removing application directory /opt/dmx-lan-bridge..."
            rm -rf /opt/dmx-lan-bridge || true
        fi

        # Reload systemd daemon
        systemctl daemon-reload || true

        echo "DMX LAN Bridge completely removed (purged)."
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # On remove (not purge), we keep data and config but remove application files
        # Remove application directory
        if [ -d /opt/dmx-lan-bridge ]; then
            echo "Removing application directory /opt/dmx-lan-bridge..."
            rm -rf /opt/dmx-lan-bridge || true
        fi

        # Just reload systemd to remove the service unit
        systemctl daemon-reload || true
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#
exit 0
