#!/bin/bash
set -e

case "$1" in
    install|upgrade)
        export DEBIAN_FRONTEND=noninteractive

        # Install pydantic v2 system-wide
        # Use --ignore-installed to avoid conflicts with apt-installed packages like typing-extensions
        echo "Installing pydantic v2 system-wide..."

        # Try with --break-system-packages and --ignore-installed
        if pip3 install --break-system-packages --ignore-installed 'pydantic>=2.0.0' 2>&1; then
            echo "✓ Pydantic v2 installed"
        elif python3 -m pip install --break-system-packages --ignore-installed 'pydantic>=2.0.0' 2>&1; then
            echo "✓ Pydantic v2 installed"
        elif pip3 install --ignore-installed 'pydantic>=2.0.0' 2>&1; then
            echo "✓ Pydantic v2 installed"
        elif python3 -m pip install --ignore-installed 'pydantic>=2.0.0' 2>&1; then
            echo "✓ Pydantic v2 installed"
        else
            echo "ERROR: Failed to install pydantic v2"
            exit 1
        fi
        ;;
esac

exit 0
