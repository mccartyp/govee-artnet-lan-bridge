#!/bin/bash
set +e

case "$1" in
    install|upgrade)
        export DEBIAN_FRONTEND=noninteractive

        # Remove system pydantic v1 package to avoid conflicts
        echo "Removing system pydantic v1 package..."
        apt-get remove -y -qq python3-pydantic 2>/dev/null || true
        apt-get autoremove -y -qq 2>/dev/null || true

        # Install pip if needed
        if ! command -v pip3 >/dev/null 2>&1 && ! python3 -m pip --version >/dev/null 2>&1; then
            apt-get update -qq >/dev/null 2>&1
            apt-get install -y -qq python3-pip >/dev/null 2>&1
        fi

        # Install pydantic v2 system-wide (for pytest and application)
        echo "Installing pydantic v2 system-wide..."
        if command -v pip3 >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
            pip3 install --break-system-packages 'pydantic>=2.0.0' >/dev/null 2>&1 || \
            python3 -m pip install --break-system-packages 'pydantic>=2.0.0' >/dev/null 2>&1 || \
            pip3 install 'pydantic>=2.0.0' >/dev/null 2>&1 || \
            python3 -m pip install 'pydantic>=2.0.0' >/dev/null 2>&1
            echo "Pydantic v2 installed successfully"
        else
            echo "WARNING: Could not install pydantic v2 - pip not available"
        fi
        ;;
esac

exit 0
