#!/bin/bash
set -e

case "$1" in
    configure)
        # Create system user and group if they don't exist
        if ! getent group govee-bridge >/dev/null 2>&1; then
            groupadd --system govee-bridge
        fi
        if ! id govee-bridge >/dev/null 2>&1; then
            useradd --system --gid govee-bridge --home-dir /var/lib/govee-bridge \
                    --shell /usr/sbin/nologin --comment "Govee ArtNet Bridge service user" \
                    --no-create-home govee-bridge
        fi

        # Ensure data directory exists with correct ownership
        if [ ! -d /var/lib/govee-bridge ]; then
            install -d -o govee-bridge -g govee-bridge -m 750 /var/lib/govee-bridge
        else
            chown govee-bridge:govee-bridge /var/lib/govee-bridge
            chmod 750 /var/lib/govee-bridge
        fi

        # Ensure config directory has correct permissions
        if [ -d /etc/govee-bridge ]; then
            chown root:govee-bridge /etc/govee-bridge
            chmod 755 /etc/govee-bridge
        fi

        # Ensure config file has correct permissions (if it exists)
        if [ -f /etc/govee-bridge/config.toml ]; then
            chown root:govee-bridge /etc/govee-bridge/config.toml
            chmod 640 /etc/govee-bridge/config.toml
        fi

        # Ensure capability catalog directory has correct permissions
        if [ -d /usr/share/govee_artnet_lan_bridge ]; then
            chown root:root /usr/share/govee_artnet_lan_bridge
            chmod 755 /usr/share/govee_artnet_lan_bridge
        fi

        # Ensure capability catalog has correct ownership and permissions
        if [ -f /usr/share/govee_artnet_lan_bridge/capability_catalog.json ]; then
            chown root:root /usr/share/govee_artnet_lan_bridge/capability_catalog.json
            chmod 644 /usr/share/govee_artnet_lan_bridge/capability_catalog.json

            # Remove ACLs if setfacl is available (Ubuntu 24.04 has ACLs that block access)
            if command -v setfacl >/dev/null 2>&1; then
                echo "Removing ACLs from capability catalog..."
                setfacl -b /usr/share/govee_artnet_lan_bridge/capability_catalog.json 2>/dev/null || true
                setfacl -b /usr/share/govee_artnet_lan_bridge 2>/dev/null || true
            else
                echo "Note: setfacl not available, skipping ACL removal"
            fi

            # Verify file is accessible
            echo "Verifying capability catalog is accessible..."
            ls -la /usr/share/govee_artnet_lan_bridge/capability_catalog.json || echo "WARNING: Cannot list file"
            if [ -r /usr/share/govee_artnet_lan_bridge/capability_catalog.json ]; then
                echo "✓ Capability catalog is readable by root"
            else
                echo "WARNING: Capability catalog is not readable by root!"
            fi

            # Test if govee-bridge user can read the file
            if command -v sudo >/dev/null 2>&1 && id govee-bridge >/dev/null 2>&1; then
                if sudo -u govee-bridge test -r /usr/share/govee_artnet_lan_bridge/capability_catalog.json 2>/dev/null; then
                    echo "✓ Capability catalog is readable by govee-bridge user"
                else
                    echo "WARNING: Capability catalog is NOT readable by govee-bridge user!"
                    echo "Directory permissions:"
                    ls -lad /usr/share/govee_artnet_lan_bridge/
                fi
            fi
        fi

        # Ensure systemd service file has correct ownership
        for svc_path in /lib/systemd/system/govee-bridge.service /usr/lib/systemd/system/govee-bridge.service; do
            if [ -f "$svc_path" ]; then
                chown root:root "$svc_path"
                chmod 644 "$svc_path"
            fi
        done

        # Reload systemd daemon
        systemctl daemon-reload || true

        # Enable service (but don't start yet if this is initial install)
        systemctl enable govee-bridge.service || true

        # On upgrade, restart the service if it was running
        # On fresh install, start the service
        if systemctl is-active --quiet govee-bridge.service; then
            echo "Restarting govee-bridge service..."
            systemctl restart govee-bridge.service || true
        else
            echo "Starting govee-bridge service..."
            systemctl start govee-bridge.service || true
        fi

        echo ""
        echo "Govee ArtNet Bridge installed successfully!"
        echo ""
        echo "Service status:"
        systemctl status govee-bridge.service --no-pager -l || true
        echo ""
        echo "Configuration: /etc/govee-bridge/config.toml"
        echo "Documentation: /usr/share/doc/govee-artnet-bridge/"
        echo ""
        echo "Check service logs: sudo journalctl -u govee-bridge.service -f"
        echo "Restart service: sudo systemctl restart govee-bridge.service"
        echo ""
        ;;
esac

#DEBHELPER#
exit 0
