# ==============================================================================
# DMX LAN Bridge - Comprehensive Configuration Example
# ==============================================================================
# This file documents ALL available configuration options for the bridge.
# For production use, copy the minimal config template from:
#   - System: /etc/artnet-bridge/config.toml
#   - User: ~/.config/artnet-bridge/config.toml
#
# After editing, reload configuration:
#   - System: sudo systemctl reload artnet-bridge.service
#   - User: systemctl --user reload artnet-bridge-user.service
#   - API: POST /reload (requires authentication)
# ==============================================================================

# ------------------------------------------------------------------------------
# DMX Input Protocols
# ------------------------------------------------------------------------------
# The bridge supports multiple DMX input protocols with priority-based merging.
# Enable the protocols you need. Both can run simultaneously.
#
# Priority Merging:
#   - When multiple sources send to the same universe, highest priority wins
#   - ArtNet: Configurable priority (default 50, below sACN default)
#   - sACN: Native priority 0-200 (default 100)
#   - Automatic failover: If primary source stops, backup takes over (2.5s timeout)
# ------------------------------------------------------------------------------

## ArtNet (Art-Net)
# Enable ArtNet input protocol (default: true)
# Widely supported, simple broadcast protocol
artnet_enabled = true

# ArtNet listening port (default: 6454, standard ArtNet port)
# This is where the bridge listens for ArtNet packets from lighting controllers
artnet_port = 6454

# ArtNet priority for source merging (default: 50)
# Range: 0-200 (higher priority wins)
# Default 50 puts ArtNet below sACN default (100) but above sACN minimum
# Adjust to control priority when mixing ArtNet and sACN sources
artnet_priority = 50

## sACN (Streaming ACN / ANSI E1.31)
# Enable sACN/E1.31 input protocol (default: false)
# Professional standard with priority control and multicast efficiency
sacn_enabled = false

# sACN listening port (default: 5568, standard sACN port)
sacn_port = 5568

# sACN multicast mode (default: true)
# true:  Join multicast groups per universe (recommended, more efficient)
# false: Unicast mode, receive on any address
sacn_multicast = true

# sACN universe subscription list (multicast mode only)
# List of universe numbers to listen on via multicast (1-63999)
# Each universe joins multicast group 239.255.(universe>>8).(universe&0xFF)
# Default: [1] (universe 1 only)
# Examples:
#   [1]           - Listen only to universe 1
#   [1, 2, 3]     - Listen to universes 1, 2, 3
#   [1, 2, 5, 10] - Listen to universes 1, 2, 5, 10
sacn_universes = [1]

# Note: In unicast mode (sacn_multicast = false), sacn_universes is ignored
#       and ALL universes are received on the configured port.

# ------------------------------------------------------------------------------
# HTTP API Configuration
# ------------------------------------------------------------------------------

# HTTP API server port (default: 8000)
# REST API and WebSocket endpoints listen on this port
api_port = 8000

# ------------------------------------------------------------------------------
# Security & Authentication
# ------------------------------------------------------------------------------

# API Key authentication (X-API-Key header or "apikey <key>" Authorization)
# Uncomment and set to require API key authentication for all API requests
# IMPORTANT: Set this for network-exposed instances!
# api_key = "your-secret-api-key-here"

# Bearer token authentication (Authorization: Bearer <token>)
# Alternative to API key. Can use both for different client types.
# api_bearer_token = "your-bearer-token-here"

# Enable API documentation endpoints (/docs, /redoc, /openapi.json)
# Set to false for production deployments to reduce attack surface
api_docs = true

# ------------------------------------------------------------------------------
# Storage & Data Paths
# ------------------------------------------------------------------------------

# SQLite database path (stores devices, mappings, queue state, health metrics)
# System service default: /var/lib/govee-bridge/bridge.sqlite3
# User service default: ~/.local/share/govee-artnet-lan-bridge/bridge.sqlite3
db_path = "/var/lib/govee-bridge/bridge.sqlite3"

# Capability catalog JSON path (device feature definitions and capabilities)
# Auto-detected from installation location if not specified
# Development: <repo>/res/capability_catalog.json
# System install: /usr/share/govee_artnet_lan_bridge/capability_catalog.json
# capability_catalog_path = "/usr/share/govee_artnet_lan_bridge/capability_catalog.json"

# ------------------------------------------------------------------------------
# Device Discovery
# ------------------------------------------------------------------------------

# Interval between discovery broadcasts (seconds)
# Lower values = faster device detection, but more network traffic
discovery_interval = 30.0

# Multicast address for device discovery (Govee protocol standard)
discovery_multicast_address = "239.255.255.250"

# Multicast port for discovery broadcasts
discovery_multicast_port = 4001

# Port for receiving discovery replies from devices
discovery_reply_port = 4002

# Discovery probe payload (JSON command broadcast to discover devices)
# DO NOT change unless you know what you're doing
# discovery_probe_payload = '{"msg":{"cmd":"scan","data":{"account_topic":"reserve"}}}'

# Timeout for discovery responses (seconds)
# Devices must respond within this time to be discovered
discovery_response_timeout = 2.0

# Mark devices as stale after this many seconds without discovery response
# Stale devices are kept in database but flagged as potentially offline
discovery_stale_after = 300.0

# Send unicast discovery probes to manually configured devices
# Recommended: true (helps discover devices on different subnets)
manual_unicast_probes = true

# Per-subsystem log level overrides (useful for debugging specific components)
# discovery_log_level = "DEBUG"

# ------------------------------------------------------------------------------
# Device Communication
# ------------------------------------------------------------------------------

# Default transport protocol for device commands
# Note: Govee devices only support UDP for control commands
device_default_transport = "udp"

# Default port for device control commands
device_default_port = 4003

# Timeout for device command responses (seconds)
device_send_timeout = 2.0

# Number of retries for failed device commands
# 0 = no retries, 1 = one retry, etc.
device_send_retries = 3

# Exponential backoff settings for command retries
device_backoff_base = 0.5        # Initial backoff delay (seconds)
device_backoff_factor = 2.0      # Multiplier for each retry (2.0 = double each time)
device_backoff_max = 5.0         # Maximum backoff delay cap (seconds)

# Maximum device command rate per device (commands/second)
# Prevents overwhelming devices with too many commands
device_max_send_rate = 10.0

# Command queue polling interval (seconds)
# How often the sender checks for new commands to send
device_queue_poll_interval = 0.5

# Wait time when command queue is empty (seconds)
# Reduces CPU usage when idle
device_idle_wait = 0.2

# Mark device offline after this many consecutive command failures
# Device will be marked offline and removed from active rotation
device_offline_threshold = 3

# Maximum queue depth per device (commands)
# If queue fills, new commands may be dropped
device_max_queue_depth = 1000

# Per-subsystem log level override
# sender_log_level = "DEBUG"

# ------------------------------------------------------------------------------
# Device Polling (Health Checks)
# ------------------------------------------------------------------------------

# Enable periodic device polling for health monitoring and status updates
# Recommended: true (allows tracking device online/offline status)
device_poll_enabled = true

# Interval between poll cycles (seconds)
# All devices are polled once per interval (distributed across the interval)
device_poll_interval = 60.0

# Timeout for individual poll responses (seconds)
device_poll_timeout = 1.5

# Polling rate limit across ALL devices (polls/second)
# Prevents network flooding when polling many devices
device_poll_rate_per_second = 2.0

# Burst allowance for polling rate limit
# Allows short bursts above the rate limit
device_poll_rate_burst = 5

# Mark device offline after this many consecutive failed polls
device_poll_offline_threshold = 2

# Maximum devices to poll per cycle
# Limits memory and CPU usage for large deployments
device_poll_batch_size = 50

# Poll payload (JSON command sent to devices for status check)
# DO NOT change unless you know what you're doing
# device_poll_payload = '{"msg":{"cmd":"devStatus","data":{"account_topic":"reserve"}}}'

# Optional: Override poll port (default: uses device_default_port)
# Useful if devices listen on different ports for status vs control
# device_poll_port = 4003

# Exponential backoff settings for failed polls
device_poll_backoff_base = 1.0       # Initial backoff (seconds)
device_poll_backoff_factor = 2.0     # Multiplier per failure
device_poll_backoff_max = 30.0       # Maximum backoff cap (seconds)

# ------------------------------------------------------------------------------
# Rate Limiting (API Protection)
# ------------------------------------------------------------------------------

# Maximum API requests per second (across all clients)
# Protects against API abuse and DoS
rate_limit_per_second = 10.0

# Burst allowance for API requests
# Allows short bursts above the rate limit
rate_limit_burst = 20

# ------------------------------------------------------------------------------
# Health Monitoring
# ------------------------------------------------------------------------------

# Number of consecutive failures before marking subsystem unhealthy
# Subsystems: discovery, dmx_mapping, artnet (if enabled), sacn (if enabled), sender, api, poller
subsystem_failure_threshold = 5

# Cooldown period after subsystem failures (seconds)
# Prevents flapping between healthy/unhealthy states
subsystem_failure_cooldown = 15.0

# ------------------------------------------------------------------------------
# Logging
# ------------------------------------------------------------------------------

# Log format
# Options:
#   - "plain": Human-readable colored text (good for systemd journals)
#   - "json": Structured JSON (good for log aggregation systems)
log_format = "plain"

# Default log level for all components
# Options: DEBUG, INFO, WARNING, ERROR, CRITICAL
log_level = "INFO"

# Per-subsystem log level overrides (override log_level for specific components)
# Useful for debugging specific issues without flooding logs
# discovery_log_level = "DEBUG"    # Device discovery verbose logging
# artnet_log_level = "INFO"        # ArtNet listener logging
# sender_log_level = "INFO"        # Device command sender logging
# api_log_level = "INFO"           # HTTP API logging

# Sample rate for noisy log messages (0.0 to 1.0)
# 1.0 = log all messages, 0.1 = log 10% of messages
# Reduces log spam for high-frequency events
noisy_log_sample_rate = 1.0

# Enable in-memory log buffering for API /logs endpoint
# Allows retrieving recent logs via API without file access
log_buffer_enabled = true

# Maximum log entries in memory buffer
# Older entries are discarded when buffer is full
log_buffer_size = 10000

# ------------------------------------------------------------------------------
# Advanced / Debugging
# ------------------------------------------------------------------------------

# Enable trace context IDs in logs (for distributed request tracing)
# Adds unique IDs to track requests across components
trace_context_ids = false

# Sample rate for trace contexts (0.0 to 1.0)
# 1.0 = trace all requests, 0.1 = trace 10% of requests
trace_context_sample_rate = 1.0

# Dry run mode: log all actions but don't send commands to devices
# Useful for testing mappings and configurations without affecting devices
dry_run = false

# Only run database migrations and exit (for maintenance)
# Useful for pre-upgrade schema updates
migrate_only = false

# Enable event bus for real-time event streaming via WebSocket API
# Allows clients to subscribe to device events, mapping changes, etc.
event_bus_enabled = true

# ------------------------------------------------------------------------------
# Manual Device Configuration (Advanced)
# ------------------------------------------------------------------------------
# Manually configure devices that don't respond to discovery.
# This is ADVANCED usage - most users should rely on automatic discovery.
#
# Use cases:
#   - Devices on different subnets (requires routing)
#   - Devices with multicast discovery disabled
#   - Testing with specific device configurations
#
# Format:
# [[manual_devices]]
# id = "AA:BB:CC:DD:EE:FF:11:22"           # Device MAC address
# ip = "192.168.1.100"                      # Device IP address
# model_number = "H6159"                    # Optional: Govee model number
# description = "Living Room LED Strip"     # Optional: Human-readable name
# led_count = 150                           # Optional: Number of LEDs
# length_meters = 5.0                       # Optional: Strip length in meters
#
# Example:
# [[manual_devices]]
# id = "34:AB:95:AB:CD:EF:01:23"
# ip = "192.168.2.50"
# model_number = "H6159"
# description = "Bedroom LED Strip"

# ------------------------------------------------------------------------------
# Configuration Version (DO NOT MODIFY)
# ------------------------------------------------------------------------------
# Internal version number for configuration schema
# Used for automatic config migrations during upgrades
config_version = 2
